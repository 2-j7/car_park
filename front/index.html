<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- å¼•å…¥äºŒç»´ç ç”Ÿæˆåº“ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¦è¾†æ”¶è´¹ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* æ¨¡æ€æ¡†èƒŒæ™¯ */
.modal {
    display: none; 
    position: fixed; 
    z-index: 1000; 
    left: 0; top: 0; 
    width: 100%; height: 100%; 
    background-color: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
}
/* å°ç¥¨å†…å®¹ */
.receipt-box {
    background: white;
    padding: 30px;
    border-radius: 10px;
    width: 300px;
    text-align: center;
    border-top: 5px solid #e74c3c;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.receipt-item {
    display: flex;
    justify-content: space-between;
    margin: 10px 0;
    border-bottom: 1px dashed #eee;
    padding-bottom: 5px;
}
.big-price { font-size: 32px; color: #e74c3c; font-weight: bold; margin: 20px 0; }
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f4f7f6;
            --white: #ffffff;
            --text-color: #333;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            height: 100vh;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: var(--white);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 1px solid #34495e;
            padding-bottom: 20px;
        }

        .menu-item {
            padding: 15px;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: #34495e;
            transition: 0.3s;
        }

        .menu-item:hover, .menu-item.active {
            background-color: var(--primary-color);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ */
        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--white);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card h3 { margin: 0; font-size: 16px; color: #7f8c8d; }
        .card p { margin: 5px 0 0; font-size: 28px; font-weight: bold; color: var(--text-color); }

        /* æ“ä½œåŒºåŸŸ */
        .action-area {
            background: var(--white);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .tab-btn {
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
            background: #eee;
            border: none;
            border-radius: 5px;
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .input-group {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="text"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 200px;
            font-size: 16px;
        }

        button.primary-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button.primary-btn:hover { opacity: 0.9; }

        /* è¡¨æ ¼åŒºåŸŸ */
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th { background-color: #f8f9fa; font-weight: 600; }
        
        .status-in { color: var(--success-color); font-weight: bold; }
        .status-out { color: #95a5a6; }

        .btn-exit {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        /* å›¾ç‰‡é¢„è§ˆ */
        #previewImg {
            max-height: 50px;
            border-radius: 5px;
            display: none;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>

    <div class="sidebar">
    <h2>ğŸš— åœè½¦ç®¡ç†ç³»ç»Ÿ</h2>
    <!-- ç»™èœå•é¡¹åŠ  IDï¼Œæ–¹ä¾¿ JS æ§åˆ¶é«˜äº® -->
    <div id="menu-manage" class="menu-item active" onclick="showManage()">ğŸš— è½¦è¾†ç®¡ç†</div>
    <div id="menu-stats" class="menu-item" onclick="showStats()">ğŸ“Š æ•°æ®æŠ¥è¡¨ç»Ÿè®¡</div>
    <div class="menu-item" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæœˆåº¦æŠ¥è¡¨</div>
</div>

  <!-- ä¸»å†…å®¹ -->
<div class="main-content">
    
    <!-- é¡¶éƒ¨ï¼š3ä¸ªç»Ÿè®¡å¡ç‰‡ (æ°¸è¿œæ˜¾ç¤º) -->
    <div class="stats-container">
        <div class="card">
            <div>
                <h3>å‰©ä½™è½¦ä½</h3>
                <p id="remainSpace">20</p>
            </div>
            <div style="font-size: 30px; color: #2ecc71;">ğŸ…¿ï¸</div>
        </div>
        <div class="card">
            <div>
                <h3>å½“å‰åœ¨åœº</h3>
                <p id="currentCars">0</p>
            </div>
            <div style="font-size: 30px; color: #4a90e2;">ğŸš˜</div>
        </div>
        <div class="card">
            <div>
                <h3>ä»Šæ—¥æ”¶ç›Š</h3>
                <p>Â¥ <span id="todayIncome">0.00</span></p>
            </div>
            <div style="font-size: 30px; color: #f1c40f;">ğŸ’°</div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- ğŸ”´ åŒºåŸŸä¸€ï¼šè½¦è¾†ç®¡ç† (é»˜è®¤æ˜¾ç¤º)            -->
    <!-- ========================================= -->
    <div id="section-manage">
        
        <!-- å…¥åœºæ“ä½œåŒº -->
        <div class="action-area">
            <h3>ğŸ“ è½¦è¾†å…¥åœºç™»è®°</h3>
            <div>
                <button class="tab-btn active" onclick="switchTab('scan')">ğŸ“¸ æ‹ç…§è¯†åˆ« (AI)</button>
                <button class="tab-btn" onclick="switchTab('manual')">âŒ¨ï¸ æ‰‹åŠ¨è¾“å…¥</button>
            </div>

            <!-- æ‹ç…§æ¨¡å¼ -->
            <div id="scanMode" class="input-group">
                <input type="file" id="fileInput" accept="image/*">
                <img id="previewImg" src="" alt="é¢„è§ˆ">
                <button class="primary-btn" onclick="uploadAndScan()" style="background-color: #e67e22;">ç¬¬ä¸€æ­¥: AI è¯†åˆ«</button>
                <span style="font-weight: bold;">â¡ï¸ è¯†åˆ«ç»“æœï¼š</span>
                <input type="text" id="scanPlateResult" placeholder="ç­‰å¾…è¯†åˆ«..." style="font-weight: bold; color: blue;">
                <button class="primary-btn" onclick="confirmEntry('scanPlateResult')">ç¬¬äºŒæ­¥: ç¡®è®¤å…¥åœº</button>
            </div>

            <!-- æ‰‹åŠ¨æ¨¡å¼ -->
            <div id="manualMode" class="input-group" style="display: none;">
                <input type="text" id="manualPlateInput" placeholder="è¯·è¾“å…¥è½¦ç‰Œå·">
                <button class="primary-btn" onclick="confirmEntry('manualPlateInput')">ç¡®è®¤å…¥åœº</button>
            </div>
        </div>

        <!-- è½¦è¾†è¡¨æ ¼ -->
        <h3>ğŸ“‹ å®æ—¶åœè½¦è®°å½•</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th><th>è½¦ç‰Œå·</th><th>å…¥åœºæ—¶é—´</th><th>ç¦»åœºæ—¶é—´</th><th>è´¹ç”¨</th><th>çŠ¶æ€</th><th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <!-- ========================================= -->
    <!-- ğŸ”µ åŒºåŸŸäºŒï¼šæ•°æ®ç»Ÿè®¡å›¾è¡¨ (é»˜è®¤éšè—)         -->
    <!-- ========================================= -->
    <div id="section-stats" style="display: none;">
        <h3>ğŸ“Š æ•°æ®å¯è§†åŒ–åˆ†æ</h3>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <!-- é¥¼å›¾ -->
            <div id="pieChart" style="width: 45%; height: 400px; background: white; padding: 20px; border-radius: 10px;"></div>
            <!-- æŸ±çŠ¶å›¾ -->
            <div id="barChart" style="width: 45%; height: 400px; background: white; padding: 20px; border-radius: 10px;"></div>
        </div>
    </div>

</div>

    <script>
// === å¿…é¡»ç¡®ä¿ ECharts å·²åŠ è½½ ===
// å¦‚æœæ²¡æœ‰è¿™ä¸€è¡Œï¼Œè¯·åŠ åœ¨ <head> é‡Œ: <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"><\/script>

// 1. æ˜¾ç¤ºã€è½¦è¾†ç®¡ç†ã€‘é¡µé¢
function showManage() {
    // åˆ‡æ¢åŒºåŸŸæ˜¾ç¤º
    document.getElementById('section-manage').style.display = 'block';
    document.getElementById('section-stats').style.display = 'none';

    // åˆ‡æ¢èœå•é«˜äº®
    document.getElementById('menu-manage').classList.add('active');
    document.getElementById('menu-stats').classList.remove('active');
    
    // é‡æ–°åŠ è½½è¡¨æ ¼æ•°æ®ï¼ˆé˜²æ­¢æ•°æ®è¿‡æ—¶ï¼‰
    loadTableData();
}

// 2. æ˜¾ç¤ºã€æ•°æ®ç»Ÿè®¡ã€‘é¡µé¢
function showStats() {
    // åˆ‡æ¢åŒºåŸŸæ˜¾ç¤º
    document.getElementById('section-manage').style.display = 'none';
    document.getElementById('section-stats').style.display = 'block';

    // åˆ‡æ¢èœå•é«˜äº®
    document.getElementById('menu-manage').classList.remove('active');
    document.getElementById('menu-stats').classList.add('active');

    // â˜…â˜…â˜… æ ¸å¿ƒï¼šå¼€å§‹æ¸²æŸ“å›¾è¡¨ â˜…â˜…â˜…
    renderCharts();
}

// 3. æ¸²æŸ“å›¾è¡¨çš„æ ¸å¿ƒé€»è¾‘
async function renderCharts() {
    // å…ˆæ£€æŸ¥ echarts æ˜¯å¦å¼•å…¥
    if (typeof echarts === 'undefined') {
        alert("ECharts åº“æœªåŠ è½½ï¼è¯·æ£€æŸ¥ HTML head éƒ¨åˆ†ã€‚");
        return;
    }

    try {
        // ä» Java åç«¯è·å–æœ€æ–°æ•°æ®
        const response = await fetch(`${JAVA_API}/list`);
        const data = await response.json();

        console.log("è·å–åˆ°ç»Ÿè®¡æ•°æ®:", data); // è°ƒè¯•ç”¨

        // --- æ•°æ®å¤„ç† ---
        let inCount = 0;
        let outCount = 0;
        let incomeData = []; // å­˜æœ€è¿‘ç¦»åœºè½¦çš„è´¹ç”¨

        data.forEach(item => {
            if(item.status === 0) {
                inCount++;
            } else {
                outCount++;
                // æ”¶é›†å·²ç¦»åœºè½¦è¾†çš„æ•°æ®ç”¨äºæŸ±çŠ¶å›¾
                incomeData.push({ name: item.plateNumber, value: item.parkingFee });
            }
        });

        // åªå–æœ€è¿‘ 5 è¾†ç¦»åœºçš„è½¦ï¼Œé˜²æ­¢æŸ±çŠ¶å›¾å¤ªæŒ¤
        const recentExit = incomeData.slice(0, 5);

        // --- åˆå§‹åŒ–å›¾è¡¨ ---
        // å¿…é¡»åŸºäº DOM å…ƒç´ å­˜åœ¨æ—¶æ‰èƒ½åˆå§‹åŒ–ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥åœ¨ showStats ä¹‹ååš
        const pieDom = document.getElementById('pieChart');
        const barDom = document.getElementById('barChart');
        
        // é”€æ¯æ—§å®ä¾‹ï¼ˆé˜²æ­¢åˆ‡å›æ¥æ—¶æŠ¥é”™ï¼‰ï¼Œæˆ–è€…æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
        const myPie = echarts.getInstanceByDom(pieDom) || echarts.init(pieDom);
        const myBar = echarts.getInstanceByDom(barDom) || echarts.init(barDom);

        // --- é…ç½®é¥¼å›¾ ---
        myPie.setOption({
            title: { text: 'è½¦è¾†åœ¨åœºçŠ¶æ€', left: 'center' },
            tooltip: { trigger: 'item' },
            legend: { bottom: '0%' },
            series: [{
                name: 'æ•°é‡',
                type: 'pie',
                radius: ['40%', '70%'], // ç¯å½¢å›¾æ›´å¥½çœ‹
                data: [
                    { value: inCount, name: 'ğŸ…¿ï¸ åœ¨åœºä¸­', itemStyle: { color: '#2ecc71' } },
                    { value: outCount, name: 'ğŸƒ å·²ç¦»åœº', itemStyle: { color: '#95a5a6' } }
                ]
            }]
        });

        // --- é…ç½®æŸ±çŠ¶å›¾ ---
        myBar.setOption({
            title: { text: 'æœ€è¿‘æ”¶ç›Šåˆ†æ', left: 'center' },
            tooltip: { trigger: 'axis' },
            xAxis: { 
                type: 'category', 
                data: recentExit.length > 0 ? recentExit.map(i => i.name) : ["æš‚æ— æ•°æ®"] 
            },
            yAxis: { type: 'value', name: 'é‡‘é¢(å…ƒ)' },
            series: [{
                data: recentExit.length > 0 ? recentExit.map(i => i.value) : [0],
                type: 'bar',
                itemStyle: { color: '#4a90e2' },
                barWidth: '40%'
            }]
        });
        
        // è‡ªé€‚åº”çª—å£å¤§å°
        window.onresize = function() {
            myPie.resize();
            myBar.resize();
        };

    } catch (error) {
        console.error("å›¾è¡¨åŠ è½½å¤±è´¥:", error);
    }
}
        // === é…ç½®åœ°å€ ===
        const PYTHON_API = "http://127.0.0.1:5000/ocr";
        const JAVA_API = "http://localhost:8080/api";

        // === é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ ===
        window.onload = function() {
            loadTableData();
        };

        // åˆ‡æ¢ Tab
        function switchTab(mode) {
            if(mode === 'scan') {
                document.getElementById('scanMode').style.display = 'flex';
                document.getElementById('manualMode').style.display = 'none';
            } else {
                document.getElementById('scanMode').style.display = 'none';
                document.getElementById('manualMode').style.display = 'flex';
            }
            // æŒ‰é’®æ ·å¼åˆ‡æ¢ï¼ˆç®€åŒ–å¤„ç†ï¼‰
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // 1. ä¸Šä¼ å¹¶è°ƒç”¨ Python è¯†åˆ«
        async function uploadAndScan() {
            const fileInput = document.getElementById('fileInput');
            if(fileInput.files.length === 0) {
                alert("è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ï¼");
                return;
            }

            // å›¾ç‰‡é¢„è§ˆ
            const imgUrl = URL.createObjectURL(fileInput.files[0]);
            const preview = document.getElementById('previewImg');
            preview.src = imgUrl;
            preview.style.display = 'block';

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            const resultInput = document.getElementById('scanPlateResult');
            resultInput.value = "è¯†åˆ«ä¸­...";

            try {
                const response = await fetch(PYTHON_API, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if(data.plate && data.plate !== "æœªè¯†åˆ«") {
                    resultInput.value = data.plate;
                } else {
                    resultInput.value = "";
                    alert("è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ‰‹åŠ¨è¾“å…¥");
                }
            } catch (error) {
                console.error(error);
                alert("æ— æ³•è¿æ¥åˆ° Python æœåŠ¡ï¼Œè¯·æ£€æŸ¥ park.py æ˜¯å¦è¿è¡Œ");
            }
        }

        // 2. è°ƒç”¨ Java å…¥åœº
       // === æ–°ç‰ˆæœ¬ï¼šå¸¦æœ‰æ ¼å¼æ ¡éªŒçš„ confirmEntry å‡½æ•° ===
async function confirmEntry(inputId) {
    const plateInput = document.getElementById(inputId);
    const plate = plateInput.value.toUpperCase(); // ç»Ÿä¸€è½¬ä¸ºå¤§å†™

    if (!plate || plate === "è¯†åˆ«ä¸­...") {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è½¦ç‰Œå·");
        return;
    }

    // --- æ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒ ---
    // è§„åˆ™: [çœä»½æ±‰å­—][A-Z][A-Z0-9]{5}  (å…¼å®¹æ–°èƒ½æºå¤šä¸€ä½çš„æƒ…å†µï¼Œç”¨{5,6})
    const plateRegex = /^[äº¬æ´¥æ²ªæ¸å†€è±«äº‘è¾½é»‘æ¹˜çš–é²æ–°è‹æµ™èµ£é„‚æ¡‚ç”˜æ™‹è’™é™•å‰é—½è´µç²¤é’è—å·å®ç¼ä½¿é¢†][A-Z][A-Z0-9]{5,6}$/;
    if (!plateRegex.test(plate)) {
        alert("è½¦ç‰Œå·æ ¼å¼ä¸æ­£ç¡®ï¼\n\nè¯·è¾“å…¥æœ‰æ•ˆçš„è½¦ç‰Œæ ¼å¼ï¼Œä¾‹å¦‚ï¼š\näº¬A88888 (è“ç‰Œ)\næ²ªD123456 (ç»¿ç‰Œ)");
        plateInput.focus(); // è®©å…‰æ ‡èšç„¦å›è¾“å…¥æ¡†
        return; // é˜»æ­¢åç»­æ“ä½œ
    }

    try {
        const response = await fetch(`${JAVA_API}/entry?plate=${encodeURIComponent(plate)}`, {
            method: 'POST'
        });
        const msg = await response.text();
        alert(msg);
        
        if(msg.includes('æˆåŠŸ')) {
             loadTableData();
             plateInput.value = '';
        }
    } catch (error) {
        alert("å…¥åœºè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Java åç«¯æ˜¯å¦è¿è¡Œ");
    }
}

        function exportData() {
    // æ¨¡æ‹Ÿæ£€æŸ¥å‘¨æœŸ
    const date = new Date();
    const isEnd = confirm(`å½“å‰ç³»ç»Ÿæ—¥æœŸï¼š${date.toLocaleDateString()}\n\næ£€æµ‹åˆ°æœ¬è®¡è´¹å‘¨æœŸï¼ˆ30å¤©ï¼‰æ•°æ®å°šæœªå½’æ¡£ã€‚\næ˜¯å¦ç«‹å³å¯¼å‡º Excel å¹¶å¼€å¯æ–°å‘¨æœŸï¼Ÿ`);
    
    if(isEnd) {
        // è¿™é‡Œå‡è£…åœ¨ä¸‹è½½
        alert("æ­£åœ¨ç”Ÿæˆ Excel æ–‡ä»¶...\n\n(æ¨¡æ‹Ÿ) å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²ä¿å­˜è‡³æ¡Œé¢ã€‚\n\nç³»ç»Ÿå‘¨æœŸå·²é‡ç½®ä¸ºï¼šCycle_2025_02");
    }
}

        // 3. è°ƒç”¨ Java ç¦»åœº
   // å…¨å±€å˜é‡ç”¨äºå­˜å‚¨å®šæ—¶å™¨ï¼Œæ–¹ä¾¿æ¸…é™¤
let pollInterval = null;

// === å¿…é¡»ä¿®æ”¹è¿™é‡Œï¼šä½ çš„ç”µè„‘å±€åŸŸç½‘IP ===
// 1. æ‰“å¼€CMDï¼Œè¾“å…¥ ipconfig æŸ¥çœ‹ IPv4 åœ°å€ (ä¾‹å¦‚ 192.168.1.5)
// 2. æ‰‹æœºå¿…é¡»è¿æ¥åŒä¸€ä¸ª WiFi
const PC_IP_ADDRESS = "192.168.71.66"; // <--- è¯·æ›¿æ¢æˆä½ çœŸå®çš„IPï¼ï¼ï¼
const SERVER_PORT = "8080";

async function exitCar(plate) {
    if (!confirm(`å‡†å¤‡ä¸ºè½¦è¾† [${plate}] åŠç†æ‰«ç æ”¯ä»˜ç»“ç®—å—ï¼Ÿ`)) return;

    // 1. è·å–è´¹ç”¨ (è°ƒç”¨Javaæ–°æ¥å£)
    let fee = 0;
    try {
        const res = await fetch(`${JAVA_API}/pay/info?plate=${plate}`); // åˆå§‹åŒ–è®¢å•
        fee = await res.json();
    } catch (e) {
        alert("æ— æ³•è¿æ¥æœåŠ¡å™¨è·å–é‡‘é¢");
        return;
    }

    // 2. æ›´æ–°å¼¹çª—UI
    document.getElementById('qr_fee_text').innerText = 'Â¥ ' + fee.toFixed(2);
    document.getElementById('paymentStatus').innerText = 'ç­‰å¾…æ‰‹æœºæ‰«ç ...';
    
    // 3. ç”Ÿæˆæ‰‹æœºè®¿é—®çš„æ”¯ä»˜é“¾æ¥
    // æ ¼å¼ï¼šhttp://192.168.1.5:8080/pay.html?plate=äº¬A88888
    const payUrl = `http://${PC_IP_ADDRESS}:${SERVER_PORT}/pay.html?plate=${encodeURIComponent(plate)}`;
    console.log("æ”¯ä»˜é“¾æ¥:", payUrl);

    // 4. ç”ŸæˆäºŒç»´ç 
    const qrContainer = document.getElementById('qrcode_box'); // éœ€è¦åœ¨HTMLé‡ŒåŠ è¿™ä¸ªID
    qrContainer.innerHTML = ""; // æ¸…ç©ºæ—§çš„
    new QRCode(qrContainer, {
        text: payUrl,
        width: 200,
        height: 200
    });

    // 5. æ˜¾ç¤ºå¼¹çª—
    const qrModal = document.getElementById('qrModal');
    qrModal.style.display = 'flex';

    // 6. å¯åŠ¨è½®è¯¢ (æ¯1ç§’é—®ä¸€æ¬¡åç«¯ï¼šç”±äºæ‰‹æœºç«¯ä»˜äº†å—ï¼Ÿ)
    if(pollInterval) clearInterval(pollInterval);
    
    pollInterval = setInterval(async () => {
        try {
            const checkRes = await fetch(`${JAVA_API}/pay/check?plate=${plate}`);
            const isPaid = await checkRes.json(); // è¿”å› true æˆ– false

            if (isPaid) {
                // === æ”¯ä»˜æˆåŠŸï¼ ===
                clearInterval(pollInterval); // åœæ­¢è½®è¯¢
                document.getElementById('paymentStatus').innerText = 'âœ… æ”¯ä»˜æˆåŠŸï¼ç³»ç»Ÿå¤„ç†ä¸­...';
                document.getElementById('paymentStatus').style.color = 'green';

                // å»¶è¿Ÿä¸€ä¸‹ï¼Œè°ƒç”¨çœŸæ­£çš„å‡ºåœºæ¥å£(å†™å…¥æ•°æ®åº“)
                setTimeout(async () => {
                    await finalExit(plate); // è°ƒç”¨åŸæœ‰çš„å‡ºåœºé€»è¾‘
                    qrModal.style.display = 'none'; // å…³äºŒç»´ç çª—
                }, 1500);
            }
        } catch (error) {
            console.log("è½®è¯¢å‡ºé”™", error);
        }
    }, 1000); // 1000ms = 1ç§’
}

// çœŸæ­£çš„å‡ºåœºå…¥åº“é€»è¾‘ï¼ˆå¤ç”¨ä¹‹å‰çš„ä»£ç ï¼‰
async function finalExit(plate) {
    try {
        const response = await fetch(`${JAVA_API}/exit?plate=${encodeURIComponent(plate)}`, {
            method: 'POST'
        });
        const msg = await response.text();
        
        // è§£æè¿”å›ä¿¡æ¯æ˜¾ç¤ºå°ç¥¨
        const durationMatch = msg.match(/æ—¶é•¿ï¼š(\d+)åˆ†é’Ÿ/);
        const feeMatch = msg.match(/è´¹ç”¨ï¼š([\d.]+)å…ƒ/);

        document.getElementById('r_plate').innerText = plate;
        document.getElementById('r_duration').innerText = (durationMatch ? durationMatch[1] : "0") + " åˆ†é’Ÿ";
        document.getElementById('r_fee').innerText = "Â¥ " + (feeMatch ? feeMatch[1] : "0.00");
        document.getElementById('receiptModal').style.display = 'flex';

        loadTableData(); // åˆ·æ–°è¡¨æ ¼
    } catch (e) {
        alert("å‡ºåœºå¤„ç†å¤±è´¥");
    }
}

// å…³é—­äºŒç»´ç å¼¹çª—æ—¶ï¼Œè®°å¾—æ¸…é™¤å®šæ—¶å™¨
function closeQrModal() {
    document.getElementById('qrModal').style.display = 'none';
    if(pollInterval) clearInterval(pollInterval);
}

// ç¡®ä¿ä½ è¿˜æœ‰ closeModal å‡½æ•°
function closeModal() {
    document.getElementById('receiptModal').style.display = 'none';
}

function closeModal() {
    document.getElementById('receiptModal').style.display = 'none';
}

        // 4. åŠ è½½è¡¨æ ¼æ•°æ®
        async function loadTableData() {
            try {
                const response = await fetch(`${JAVA_API}/list`);
                const data = await response.json();
                
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = ''; // æ¸…ç©º

                let activeCount = 0;
                let totalIncome = 0;

                data.forEach(item => {
                    // ç»Ÿè®¡
                    if(item.status === 0) activeCount++;
                    if(item.status === 1) totalIncome += item.parkingFee;

                    const tr = document.createElement('tr');
                    
                    // çŠ¶æ€æ ·å¼
                    const statusHtml = item.status === 0 
                        ? '<span class="status-in">ğŸ…¿ï¸ åœ¨åœº</span>' 
                        : '<span class="status-out">ğŸƒ å·²ç¦»åœº</span>';
                    
                    // æ“ä½œæŒ‰é’®
                    const actionHtml = item.status === 0
                        ? `<button class="btn-exit" onclick="exitCar('${item.plateNumber}')">ç»“ç®—ç¦»åœº</button>`
                        : '-';

                    tr.innerHTML = `
                        <td>${item.id}</td>
                        <td style="font-weight:bold; color:#2c3e50">${item.plateNumber}</td>
                        <td>${item.entryTime}</td>
                        <td>${item.exitTime || '-'}</td>
                        <td style="color:#e67e22; font-weight:bold">${item.parkingFee ? 'Â¥'+item.parkingFee : '-'}</td>
                        <td>${statusHtml}</td>
                        <td>${actionHtml}</td>
                    `;
                    tbody.appendChild(tr);
                });

                // æ›´æ–°é¡¶éƒ¨å¡ç‰‡
                document.getElementById('currentCars').innerText = activeCount;
                document.getElementById('remainSpace').innerText = 20 - activeCount;
                document.getElementById('todayIncome').innerText = totalIncome.toFixed(2);

            } catch (error) {
                console.error("æ— æ³•è·å–æ•°æ®", error);
            }
        }
    </script>
    <!-- ç»“ç®—å¼¹çª— -->
<div id="receiptModal" class="modal">
    <div class="receipt-box">
        <h3>ğŸ§¾ åœè½¦ç»“ç®—å•</h3>
        <div class="receipt-item"><span>è½¦ç‰Œå·</span><span id="r_plate">--</span></div>
        <div class="receipt-item"><span>å…¥åœºæ—¶é—´</span><span id="r_entry">--</span></div>
        <div class="receipt-item"><span>ç¦»åœºæ—¶é—´</span><span id="r_exit">--</span></div>
        <div class="receipt-item"><span>åœè½¦æ—¶é•¿</span><span id="r_duration">-- åˆ†é’Ÿ</span></div>
        <div class="big-price" id="r_fee">Â¥0.00</div>
        <button class="primary-btn" onclick="closeModal()" style="width:100%">ç¡®è®¤æ”¶æ¬¾ & æŠ¬æ†</button>
    </div>
</div>
<!-- æ–°å¢ï¼šäºŒç»´ç æ”¯ä»˜å¼¹çª— (é»˜è®¤éšè—) -->
<!-- äºŒç»´ç æ”¯ä»˜å¼¹çª— -->
<div id="qrModal" class="modal">
    <div class="receipt-box" style="border-top-color: #2ecc71;">
        <span onclick="closeQrModal()" style="float:right; cursor:pointer; font-size:20px;">&times;</span>
        <h3>å¾®ä¿¡æ‰«ç æ”¯ä»˜</h3>
        
        <!-- è¿™é‡Œæ˜¯ç”ŸæˆäºŒç»´ç çš„å®¹å™¨ -->
        <div id="qrcode_box" style="display:flex; justify-content:center; margin: 20px 0;"></div>
        
        <p id="qr_fee_text" style="font-size: 24px; color: #e74c3c; font-weight: bold;">Â¥ 0.00</p>
        <p style="color: #7f8c8d; font-size:12px;">è¯·ç¡®ä¿æ‰‹æœºè¿æ¥åŒä¸€WiFi</p>
        <p id="paymentStatus" style="font-weight: bold; min-height: 20px; color: #4a90e2;">ç­‰å¾…æ‰«ç ...</p>
    </div>
</div>
</body>
</html>